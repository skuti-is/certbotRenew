#!/bin/bash

minAge="+60" # days
crtDir="/etc/letsencrypt/live"

err(){
  echo "error: $*"
  exit 1
}

noCrtDir(){
  echo "To create create new certificate run"
  echo "certbot certonly --webroot -w <docRoot> -d <domain> [-d domainalias>]"
  exit 0
}

# verify install
certbot=$(which certbot)
if [ -z "$certbot" ]; then
  apt-get -y install software-properties-common
  addAptRepository=$(which add-apt-repository)||err "software-properties-common missing"
  $addAptRepository -yu ppa:certbot/certbot||err "add certbot ppa manualy"
  apt-get -y install certbot
  certbot=$(which certbot)||err "install certbot manualy"
fi

# find ex certs
[ -d "$crtDir" ]||noCrtDir
renew=$(find "$crtDir" -maxdepth 1 -mindepth 1 -type d -mtime $minAge|wc -l)

if [ $renew -eq 0 ]; then
  # nothing to renew
  exit 0
fi

# renew certificates
$certbot renew --webroot --quiet 

# reload webserver
nginx=$(which nginx)&&$nginx -sreload
apache2ctl=$(which apache2ctl)&&$apache2ctl -k graceful
